# TIL | 2025.03.04

## 📌 TIL 요약

### ✅ 스마일게이트 프로젝트 기능 구현

-   초대 링크 로직 설계 및 정리
-   쿼리 키 팩토리

### ✅ 스마일게이트 기술 멘토링

-   스마게 캠프장님 기술 멘토링 내용 공부 및 정리

---

# TIL 상세

## 🔗 초대 링크

슬랙 클론 프로젝트에서 초대 링크 복사하기 기능을 구현해야하는데 명확히 정한바가 없어서 먼저 로직을 생각하고 말씀을 드리고자 정리하였다.

현재 초대 링크 복사 로직은 다음과 같다.

-   `POST`로 `workspaceId`를 전송하면, 응답으로 초대 링크를 반환한다.

여기서 내 고민은 다음과 같다.

-   또한 초대 링크 요청 로직을 커스텀 훅으로 따로 분리했는데, `isLoading`, `isError`를 어디에서 선언하고 사용하는 것이 더 적절할지 고민이다.
    -   (커스텀 훅 내부에서 관리할지, 훅을 사용하는 컴포넌트에서 처리할지)

## ✅ 초대 링크 수락

유저가 초대 링크를 통해 초대 수락 페이지에 들어왔을 때의 다양한 상황에서의 고민이 많았다.

-   만약 우리 서비스 유저가 아니라면

    -   로그인 페이지로 이동시켜 이메일 인증을 완료하게 하고, 인증 완료 후 다시 초대 수락 페이지로 돌아오게 해야 한다.

-   만약 우리 서비스 유저라면

    -   로그인 여부를 어떻게 확인할 것인지부터 로직이 필요하다. (쿠키, 토큰 등을 이용해 체크하는 방식 검토)

> 여기서 문제는, 인증 및 권한 검증을 처리하기 위한 구체적인 로직이 정해지지 않았다.

## ✅ 초대 링크 수락 로직

### 🔐 일반 로그인 시 권한 인가 처리

1. 로그인 시 서버 응답으로

    - `Access Token`은 Response Header에, `Refresh Token`은 Response Cookie에 담겨온다.

2. 받은 토큰들을 쿠키에 저장한다. (쿠키 동작방식 공부 필요)

3. 이후 요청 시 쿠키에 저장된 Access Token을 꺼내서 `Request Header`에 담아 전송한다.

    - 이때, `withCredentials: true` 설정을 해줘야 하는지 잘 몰라서 공부해야한다.
    - 단순히 쿠키로 자동 전송할지, 쿠키에서 꺼내서 Header에 `Bearer Token`에 담아서 보내야하는건지 공부가 필요하다.

4. 로그인한 이력이 있는 유저라면, 쿠키에 저장된 Access Token을 이용해 권한 인가용 API에 요청을 보낸다. (브라우저를 닫아도 쿠키에 저장된 토큰은 유지된다.)

### 🔗 초대 수락 페이지 로직

-   서버에서 초대 수락 URL을 `domain/invite/${workspaceId}` 형태로 제공하면, 프론트엔드에서 해당 URL에 대응하는 초대 수락 페이지를 만든다.

-   초대 수락 페이지에 접속한 유저가 초대 수락 액션을 수행하면, 서버에 본인 확인 API를 호출해 유저 정보를 검증한다.

    -   이때 인증 정보는 `withCredentials` 설정을 통해 쿠키를 자동으로 전송할지, 혹은 Header에 Bearer Token을 담아 보내야하는건지 공부가 필요하다.

## ✅ 권한 인가 및 접근

비정상적인 접근(예: 권한 없는 페이지 접근)에 대한 처리는 다음과 같이 구상하고 있다.

-   유저가 우리 서비스 유저가 아니라면 → 로그인/회원가입 페이지로 이동
-   로그인은 했지만, 해당 워크스페이스에 속해있지 않은 경우 → 워크스페이스 참여 페이지로 이동
-   정상적인 유저이고, 워크스페이스에 속해있다면 → 정상 접근 허용

## ✅ 기술 멘토링

스마게 캠프장님께 마지막 기술 멘토링을 받았던걸 정리하려한다.

---

# 3월 4일 회의 후 결론

-   로그인 시 서버 응답으로
    -   `Access Token`은 Response Header에,
    -   `Refresh Token`은 Response Cookie에 담겨온다.
-   response에서 토큰을 꺼내와 쿠키에 저장한다
-   request 요청을 보낼때 쿠키에서 access 토큰을 꺼내와 header에 담아서 보내준다
-   쿠키에서 엑세스 토큰을 꺼내와서 활용
    -   엑세스 토큰 만료시 리프레시 토큰으로 발급 요청
    -   리프레시가 만료되었다면
-   유저의 권한인가 체크
    -   우리 서비스 유저인지 확인하는 방법(엑세스 토큰이 쿠키에 없다면 로그인 페이지, 만료 or 우리 서비스 이용자 아님)
        -   엑세스 토큰이 없다면 우리 서비스 이용자 아님
    -   우리 서비스 유저라면 초대 링크 클릭 시 워크스페이스 소속 여부 반환 api에 요청하여 해당 워크스페이스에 속해있는지
        -   속해있다면 workspace로 이동
        -   속하지 않았다면 워크스페이스 프로필 등록 페이지로 이동
-   초대 수락
    -   서버에서 초대 수락 URL을 `domain/invite/${invitecode}` 형태로 제공하면, 프론트엔드에서 해당 URL에 대응하는 초대 수락 페이지로 라우팅을 제공한다.
    -   본인 확인 api 주소에 invitecode를 넣어서 서버에 보내주면 workspaceId를 추출해서 해당 유저인지 확인하고 response를 던져준다

## 나의 구현

## 공부할 키워드

-   인증 인가
-   JWT 기반 인증
-   권한 인가 라우팅

### 공부 관련 링크

-   https://velog.io/@chuu1019/Access-Token%EA%B3%BC-Refresh-Token%EC%9D%B4%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B4%EA%B3%A0-%EC%99%9C-%ED%95%84%EC%9A%94%ED%95%A0%EA%B9%8C
